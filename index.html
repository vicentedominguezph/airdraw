<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AirDraw — Dibuja en el aire con tu mano</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; background: #0a0a0a; color: #eaeaea; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
    .wrap { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; font-weight: 600; }
    .row { display: grid; gap: 12px; }
    .stage { position: relative; background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 6px 24px rgba(0,0,0,.4); }
    video, canvas { display: block; width: 100%; height: auto; }
    video { opacity: .6; transform: scaleX(-1); }
    canvas.overlay { position: absolute; inset: 0; pointer-events: none; }
    .panel { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; background: #151515; border-radius: 16px; padding: 12px; }
    button, select, input[type="range"] { background: #242424; border: 1px solid #363636; color: inherit; border-radius: 12px; padding: 8px 12px; }
    button:hover { filter: brightness(1.1); cursor: pointer; }
    .swatch { width: 28px; height: 28px; border-radius: 10px; border: 1px solid #3a3a3a; }
    .tips { background: #151515; border-radius: 16px; padding: 12px; font-size: 14px; line-height: 1.45; }
    .spacer { flex: 1 1 auto; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AirDraw · Dibuja en el aire con tu mano</h1>
    <div class="row">
      <div class="stage">
        <video id="video" playsinline muted></video>
        <canvas id="paint"></canvas>
        <canvas id="overlay" class="overlay"></canvas>
      </div>

      <div class="panel">
        <button id="btnRun">Iniciar</button>
        <button id="btnClear">Limpiar (Space)</button>
        <label>Grosor
          <input id="thickness" type="range" min="2" max="32" value="6" />
          <span id="thLbl" class="mono">6</span>
        </label>
        <label>Color</label>
        <button id="colorBtn" class="swatch" title="Cambiar color (C)"></button>
        <button id="btnEraser">Goma</button>
        <label>Mano
          <select id="handed">
            <option value="any">Cualquiera</option>
            <option value="left">Izquierda</option>
            <option value="right">Derecha</option>
          </select>
        </label>
        <div class="spacer"></div>
        <label><input type="checkbox" id="chkLandmarks" checked /> Landmarks (L)</label>
      </div>

      <div class="tips">
        <ul>
          <li>Junta pulgar e índice para <strong>dibujar</strong>. Separa para dejar de pintar.</li>
          <li>Atajos: Space = limpiar, C = color, E = goma, L = landmarks.</li>
          <li>Mejor iluminación frontal = trazos más estables.</li>
        </ul>
      </div>
    </div>
  </div>

  <script type="module">
    import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8";

    const COLORS = ["#00E5FF","#FF3B30","#34C759","#FFCC00","#5856D6","#FF2D55","#FFFFFF","#111111"];
    let colorIdx = 0;

    const video = document.getElementById("video");
    const paint = document.getElementById("paint");
    const overlay = document.getElementById("overlay");
    const g = paint.getContext("2d");
    const og = overlay.getContext("2d");

    const btnRun = document.getElementById("btnRun");
    const btnClear = document.getElementById("btnClear");
    const thickness = document.getElementById("thickness");
    const thLbl = document.getElementById("thLbl");
    const colorBtn = document.getElementById("colorBtn");
    const btnEraser = document.getElementById("btnEraser");
    const handed = document.getElementById("handed");
    const chkLandmarks = document.getElementById("chkLandmarks");

    let running = false;
    let eraser = false;
    let lastPoint = null;
    let lastTs = 0;
    const FPS = 30;
    let handLandmarker = null;

    function cssSize(el) {
      return { w: el.clientWidth, h: el.clientHeight };
    }

    function resizeCanvases() {
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      for (const c of [paint, overlay]) {
        c.width = w * dpr;
        c.height = h * dpr;
        c.style.width = w + "px";
        c.style.height = h + "px";
        const ctx = c.getContext("2d");
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
    }

    function setColorBtn() {
      colorBtn.style.background = eraser ? "transparent" : COLORS[colorIdx];
    }

    function clearPaint() {
      g.clearRect(0, 0, paint.width, paint.height);
      lastPoint = null;
    }

    function dist(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    function smooth(prev, next, alpha = 0.4) {
      if (!prev) return next;
      return { x: prev.x + alpha * (next.x - prev.x), y: prev.y + alpha * (next.y - prev.y) };
    }

    function drawPoint(p) {
      if (!lastPoint) lastPoint = p;
      g.lineCap = "round";
      g.lineJoin = "round";
      g.globalCompositeOperation = eraser ? "destination-out" : "source-over";
      g.strokeStyle = eraser ? "rgba(0,0,0,1)" : COLORS[colorIdx];
      g.lineWidth = +thickness.value;
      g.beginPath();
      g.moveTo(lastPoint.x, lastPoint.y);
      g.lineTo(p.x, p.y);
      g.stroke();
      lastPoint = p;
    }

    function drawLandmarks(kps) {
      og.clearRect(0, 0, overlay.width, overlay.height);
      if (!chkLandmarks.checked) return;
      og.save();
      og.fillStyle = "rgba(0,0,0,.6)";
      og.strokeStyle = "rgba(255,255,255,.9)";
      og.lineWidth = 2;
      for (const kp of kps) {
        og.beginPath();
        og.arc(kp.x, kp.y, 3, 0, Math.PI * 2);
        og.fill();
      }
      og.restore();
    }

    btnClear.onclick = clearPaint;
    thickness.oninput = () => thLbl.textContent = thickness.value;
    colorBtn.onclick = () => { colorIdx = (colorIdx + 1) % COLORS.length; setColorBtn(); };
    btnEraser.onclick = () => { eraser = !eraser; btnEraser.textContent = eraser ? "Goma ON" : "Goma"; setColorBtn(); };
    setColorBtn();

    window.addEventListener("keydown", (e) => {
      if (e.code === "Space") { e.preventDefault(); clearPaint(); }
      if (e.key.toLowerCase() === "c") { colorBtn.click(); }
      if (e.key.toLowerCase() === "e") { btnEraser.click(); }
      if (e.key.toLowerCase() === "l") { chkLandmarks.checked = !chkLandmarks.checked; }
    });

    async function setup() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      await video.play();
      resizeCanvases();

      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm"
      );

      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm/hand_landmarker.task"
        },
        runningMode: "VIDEO",
        numHands: 1
      });
    }

    function toCanvasCoords(lm) {
      const { w, h } = cssSize(overlay);
      return { x: (1 - lm.x) * w, y: lm.y * h };
    }

    async function loop(ts) {
      if (!running) return;
      const minInt = 1000 / FPS;
      if (ts - lastTs < minInt) { requestAnimationFrame(loop); return; }
      lastTs = ts;

      const res = handLandmarker.detectForVideo(video, ts);
      if (res?.landmarks?.length) {
        const lm = res.landmarks[0];
        const thumb = toCanvasCoords(lm[4]);
        const index = toCanvasCoords(lm[8]);
        const indexBase = toCanvasCoords(lm[5]);
        const handScale = Math.max(8, dist(indexBase, index));
        const pinch = dist(index, thumb);
        const isDrawing = pinch < handScale * 0.45;

        const smoothed = smooth(lastPoint, index, 0.4);
        if (isDrawing) drawPoint(smoothed); else lastPoint = smoothed;

        drawLandmarks(lm.map(toCanvasCoords));
      } else {
        lastPoint = null;
        og.clearRect(0, 0, overlay.width, overlay.height);
      }

      requestAnimationFrame(loop);
    }

    btnRun.onclick = async () => {
      if (!handLandmarker) await setup();
      running = !running;
      btnRun.textContent = running ? "Detener" : "Iniciar";
      if (running) requestAnimationFrame(loop);
    };

    window.addEventListener("resize", resizeCanvases);
  </script>
</body>
</html>
